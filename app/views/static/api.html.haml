- content_for :title, "API"
%h1= yield :title

%p The API allows you to programatically retrieve data from any public scraper using an SQL query. It's all pretty easy.

%pre
  %code
    curl -H "x-api-key:<em>[api_key]</em>" "#{api_root}<em>[scraper]</em>/data.json?query=<em>[sql]</em>"
    

%h2 Parameters

= semantic_form_for @scraper, html: {class: "form-horizontal"} do |f|
  = f.inputs do
    .string.input.optional.stringish.form-group#scraper_full_name_input
      %label.control-label.col-sm-1(for="scraper_full_name") [scraper]
      .col-sm-11
        %input.form-control#scraper_full_name(maxlength="255" name="scraper[full_name]" type="text" value="#{@scraper.full_name}")
        %span.help-block The full name of the scraper as seen in the url (e.g. #{@scraper.full_name})
    .string.input.optional.stringish.form-group#query_input
      %label.control-label.col-sm-1(for="query") [sql]
      .col-sm-11
        %input.form-control#query(maxlength="255" name="query" type="text" value="#{@query}")
        %span.help-block
          The SQL query to perform on the SQLite database that is the output of the scraper (e.g. "#{@query}").
          Ensure it is #{link_to "url encoded", "https://en.wikipedia.org/wiki/Percent-encoding"}.
    .string.input.optional.stringish.form-group#api_key_input
      %label.control-label.col-sm-1(for="api_key") [api_key]
      .col-sm-11
        %p.form-control-static#api_key= current_user.api_key
        %span.help-block
          Your personal api key which should only be used by you.

%h2 Full URL
%p
  To do the API query with the values above

%pre
  %code
    curl -H "x-api-key:#{current_user.api_key}" "#{scraper_data_url(@scraper, host: api_host, query: @query, format: :json)}"

:javascript
  $(function() {
    function update_url() {
      var scraper = $("#scraper_full_name").val();
      var sql = $("#query").val();
      var api_key = $("#api_key").html();
      // Would be nice for this not to be hardcoded
      var host = "https://morph.io";

      command = "curl -H \"x-api-key:" + api_key + "\" \"" + host + "/" + scraper + "/data.json?query=" + encodeURIComponent(sql) + "\""
      $("code").html(command);
    }

    update_url();
    $("#scraper_full_name").change(update_url);
    $("#scraper_full_name").keyup(update_url);
    $("#query").change(update_url);
    $("#query").keyup(update_url);
  });
